generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// Enums
enum UserRole {
  admin
  agent
}

enum ClientStatus {
  new
  in_progress
  treated
  relaunched
  closed
}

enum MessageDirection {
  inbound
  outbound
}

enum MessageStatus {
  sent
  delivered
  read
}

enum MediaType {
  image
  video
  audio
  document
}

enum EntityType {
  client
  agent
  message
  status
}

// Models

model User {
  id            String    @id @default(uuid())
  name          String
  email         String    @unique
  passwordHash  String?
  avatar        String?
  role          String    @default("agent") // SQLite doesn't support enums natively, treating as String
  isActive      Boolean   @default(true)
  agentStatus   String    @default("online") // "online", "on_break", "offline"
  clientCount   Int       @default(0)
  createdAt     DateTime  @default(now())
  deletedAt     DateTime? // Soft delete timestamp
  
  // Relations
  assignedClients Client[]  @relation("AssignedAgent")
  actionLogs      ActionLog[]
  statusChanges   StatusHistory[]
  sessions        Session[]
  reminders       Reminder[]
  agentBreaks     AgentBreak[]
  smartLists      SmartList[]
  
  @@map("users")
}

model AgentBreak {
  id        String    @id @default(uuid())
  userId    String
  type      String    // "lunch", "short_break", etc
  startTime DateTime  @default(now())
  endTime   DateTime?
  duration  Int?      // Duration in seconds
  
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("agent_breaks")
}

model Client {
  id              String         @id @default(uuid())
  name            String
  phoneNumber     String?        // Made optional, platformId is the new unique identifier
  platform        String         @default("whatsapp") // "whatsapp", "instagram", "messenger"
  platformId      String         // Unique ID from the platform (JID for WA, PSID for FB, etc.)
  status          String         @default("new") // Application level enum: ClientStatus
  assignedAgentId String?
  notes           String         @default("")
  email           String?
  company         String?
  address         String?
  source          String?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  lastMessageAt   DateTime?
  
  // Relations
  assignedAgent   User?          @relation("AssignedAgent", fields: [assignedAgentId], references: [id])
  messages        Message[]
  tags            ClientTag[]
  statusHistory   StatusHistory[]
  reminders       Reminder[]
  opportunities   Opportunity[]

  @@unique([platform, platformId])
  @@map("clients")
}

model Tag {
  id    Int         @id @default(autoincrement())
  name  String      @unique
  
  // Relations
  clients ClientTag[]

  @@map("tags")
}

model ClientTag {
  clientId String
  tagId    Int

  client   Client @relation(fields: [clientId], references: [id], onDelete: Cascade)
  tag      Tag    @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([clientId, tagId])
  @@map("client_tags")
}

model Message {
  id          String    @id @default(uuid())
  clientId    String
  content     String
  mediaUrl    String?
  mediaType   String?   // Application level enum: MediaType
  direction   String    // Application level enum: MessageDirection
  status      String    @default("sent") // Application level enum: MessageStatus
  platform    String    @default("whatsapp")
  channel     String?   // crm, whatsapp, meta
  timestamp   DateTime  @default(now())

  // Relations
  client      Client    @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@map("messages")
}

model StatusHistory {
  id          String   @id @default(uuid())
  clientId    String
  fromStatus  String?  // ClientStatus
  toStatus    String   // ClientStatus
  changedBy   String?
  changedAt   DateTime @default(now())
  note        String?

  // Relations
  client      Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  user        User?    @relation(fields: [changedBy], references: [id])

  @@map("status_history")
}

model ActionLog {
  id          String   @id @default(uuid())
  userId      String
  userName    String
  action      String
  entityType  String   // EntityType
  entityId    String
  details     String?
  timestamp   DateTime @default(now())

  // Relations
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("action_logs")
}

model Session {
  id          String    @id @default(uuid())
  userId      String
  token       String    @unique
  expiresAt   DateTime
  createdAt   DateTime  @default(now())
  
  // Activity tracking
  ipAddress   String?
  userAgent   String?
  loggedOutAt DateTime?
  
  // Relations
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("sessions")
}

model Template {
  id        String   @id @default(uuid())
  name      String
  content   String
  category  String?  // e.g., 'greeting', 'sales', 'support'
  createdBy String?  // User ID
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("templates")
}

model Reminder {
  id          String   @id @default(uuid())
  clientId    String
  userId      String
  title       String
  description String?
  dueDate     DateTime
  status      String   @default("pending") // "pending" | "completed"
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  client      Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("reminders")
}

model PipelineStage {
  id            String        @id @default(uuid())
  name          String
  order         Int           @default(0)
  color         String?       @default("#3b82f6")
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  
  opportunities Opportunity[]

  @@map("pipeline_stages")
}

model Opportunity {
  id          String        @id @default(uuid())
  clientId    String
  stageId     String
  value       Float         @default(0)
  status      String        @default("active") // "active", "won", "lost"
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  client      Client        @relation(fields: [clientId], references: [id], onDelete: Cascade)
  stage       PipelineStage @relation(fields: [stageId], references: [id], onDelete: Cascade)

  @@map("opportunities")
}

// --- Workflow Automation ---

model Workflow {
  id          String           @id @default(uuid())
  name        String
  description String?
  isActive    Boolean          @default(true)
  triggers    WorkflowTrigger[]
  actions     WorkflowAction[]
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  @@map("workflows")
}

model WorkflowTrigger {
  id          String   @id @default(uuid())
  workflowId  String
  workflow    Workflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)
  type        String   // on_client_created, on_status_change, on_message_received, on_opportunity_stage_change
  config      String   // JSON configuration (e.g., { "status": "interested" } or { "keyword": "prix" })
  createdAt   DateTime @default(now())

  @@map("workflow_triggers")
}

model WorkflowAction {
  id          String   @id @default(uuid())
  workflowId  String
  workflow    Workflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)
  type        String   // send_message, add_tag, assign_agent, update_status, create_opportunity
  config      String   // JSON configuration (e.g., { "message": "Bonjour", "tagId": 1 })
  order       Int      @default(0)
  createdAt   DateTime @default(now())

  @@map("workflow_actions")
}

model SmartList {
  id        String   @id @default(uuid())
  name      String
  filters   String   // JSON string storing filter criteria
  userId    String?  // Optional: link to a specific user or keep global
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user      User?    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("smart_lists")
}
