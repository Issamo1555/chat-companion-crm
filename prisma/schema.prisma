generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// Enums
enum UserRole {
  admin
  agent
}

enum ClientStatus {
  new
  in_progress
  treated
  relaunched
  closed
}

enum MessageDirection {
  inbound
  outbound
}

enum MessageStatus {
  sent
  delivered
  read
}

enum MediaType {
  image
  video
  audio
  document
}

enum EntityType {
  client
  agent
  message
  status
}

// Models

model User {
  id            String    @id @default(uuid())
  name          String
  email         String    @unique
  passwordHash  String?
  avatar        String?
  role          String    @default("agent") // SQLite doesn't support enums natively, treating as String
  isActive      Boolean   @default(true)
  clientCount   Int       @default(0)
  createdAt     DateTime  @default(now())
  deletedAt     DateTime? // Soft delete timestamp
  
  // Relations
  assignedClients Client[]  @relation("AssignedAgent")
  actionLogs      ActionLog[]
  statusChanges   StatusHistory[]
  sessions        Session[]
  
  @@map("users")
}

model Client {
  id              String         @id @default(uuid())
  name            String
  phoneNumber     String
  status          String         @default("new") // Application level enum: ClientStatus
  assignedAgentId String?
  notes           String         @default("")
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  lastMessageAt   DateTime?
  
  // Relations
  assignedAgent   User?          @relation("AssignedAgent", fields: [assignedAgentId], references: [id])
  messages        Message[]
  tags            ClientTag[]
  statusHistory   StatusHistory[]

  @@map("clients")
}

model Tag {
  id    Int         @id @default(autoincrement())
  name  String      @unique
  
  // Relations
  clients ClientTag[]

  @@map("tags")
}

model ClientTag {
  clientId String
  tagId    Int

  client   Client @relation(fields: [clientId], references: [id], onDelete: Cascade)
  tag      Tag    @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([clientId, tagId])
  @@map("client_tags")
}

model Message {
  id          String    @id @default(uuid())
  clientId    String
  content     String
  mediaUrl    String?
  mediaType   String?   // Application level enum: MediaType
  direction   String    // Application level enum: MessageDirection
  status      String    @default("sent") // Application level enum: MessageStatus
  timestamp   DateTime  @default(now())

  // Relations
  client      Client    @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@map("messages")
}

model StatusHistory {
  id          String   @id @default(uuid())
  clientId    String
  fromStatus  String?  // ClientStatus
  toStatus    String   // ClientStatus
  changedBy   String?
  changedAt   DateTime @default(now())
  note        String?

  // Relations
  client      Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  user        User?    @relation(fields: [changedBy], references: [id])

  @@map("status_history")
}

model ActionLog {
  id          String   @id @default(uuid())
  userId      String
  userName    String
  action      String
  entityType  String   // EntityType
  entityId    String
  details     String?
  timestamp   DateTime @default(now())

  // Relations
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("action_logs")
}

model Session {
  id          String    @id @default(uuid())
  userId      String
  token       String    @unique
  expiresAt   DateTime
  createdAt   DateTime  @default(now())
  
  // Activity tracking
  ipAddress   String?
  userAgent   String?
  loggedOutAt DateTime?
  
  // Relations
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("sessions")
}
